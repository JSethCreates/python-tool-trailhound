
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>TrailHound v3.5</title>
    <style>
        :root {
            --primary: #1e88e5;
            --background: #f4f7fa;
            --card-bg: #ffffff;
            --border: #d0d0d0;
            --text: #333;
            --radius: 10px;
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: var(--background);
            margin: 0;
            padding: 20px;
            color: var(--text);
        }
        h2 {
            color: var(--primary);
        }
        input[type="text"], button {
            font-size: 14px;
            padding: 10px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
        }
        button {
            background: var(--primary);
            color: #fff;
            cursor: pointer;
            border: none;
            transition: background 0.3s;
        }
        button:hover {
            background: #1565c0;
        }
        #top-controls, #search-controls {
            margin-bottom: 20px;
        }
        #folderInput {
            width: 60%;
            margin-bottom: 10px;
        }
        #folderList {
            width: 100%;
            max-height: 300px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            overflow-y: auto;
            padding: 10px;
            border-radius: var(--radius);
        }
        #results {
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
            gap: 20px;
        }
        .result {
            flex: 0 0 500px;
            background: var(--card-bg);
            padding: 15px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }
        iframe {
            display: block;
            margin-top: 10px;
            width: 100%;
            height: 280px;
            border: none;
            border-radius: var(--radius);
        }
        .controls {
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .folder-item {
            cursor: pointer;
            padding: 5px;
            border-radius: var(--radius);
            transition: background 0.2s;
        }
        .folder-item:hover, .folder-item.active {
            background-color: #e3f2fd;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="top-controls">
        <input type="text" id="folderInput" placeholder="Enter media directory path">
        <button onclick="browseAndScan()">Browse...</button>
        <div id="folderList"><em>Folder list will appear here after scanning.</em></div>
    </div>

    <div id="search-controls">
        <h2>YouTube Search</h2>
        <input type="text" id="searchInput" placeholder="Search YouTube..." size="40">
        <button onclick="performSearch()">Search</button>
    </div>

    <div id="results"></div>

    <script>
        let selectedFolder = null;

        document.getElementById('searchInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') performSearch();
        });

        async function browseAndScan() {
            const path = await window.pywebview.api.select_folder();
            if (path && path.length > 0) {
                document.getElementById('folderInput').value = path[0];
                scanFolders(path[0]);
            }
        }

        async function scanFolders(path) {
            const list = await window.pywebview.api.scan(path);
            const folderList = document.getElementById('folderList');
            folderList.innerHTML = '';
            if (list.error) {
                folderList.innerHTML = `<p>${list.error}</p>`;
                return;
            }
            list.forEach(folder => {
                const item = document.createElement('div');
                item.className = 'folder-item';
                item.textContent = `${folder.found ? '✅' : '❌'} ${folder.name}`;
                item.onclick = async () => {
                    selectedFolder = folder.name;
                    await window.pywebview.api.set_foldername(folder.name);
                    document.getElementById('searchInput').value = `${folder.name} trailer`;
                    performSearch();
                    document.querySelectorAll('.folder-item').forEach(f => f.classList.remove('active'));
                    item.classList.add('active');
                };
                folderList.appendChild(item);
            });
        }

        async function performSearch() {
            const query = document.getElementById('searchInput').value;
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<p>Loading...</p>';

            const results = await window.pywebview.api.search(query);
            resultsDiv.innerHTML = '';

            if (!results || results.error) {
                resultsDiv.innerHTML = `<p>Error: ${results.error}</p>`;
                return;
            }

            results.forEach(async video => {
                const container = document.createElement('div');
                container.className = 'result';

                const title = document.createElement('h3');
                title.textContent = video.title;

                const iframe = document.createElement('iframe');
                iframe.src = video.embed;

                const controls = document.createElement('div');
                controls.className = 'controls';

                controls.innerHTML = `
                    <strong>Resolution:</strong> <span class="resDisplay">Loading...</span><br>
                    <label>Start: <input type="text" value="0:00" class="startTime" size="5"></label>
                    <label>End: <input type="text" value="" class="endTime" size="5"></label>
                    <button class="downloadBtn">Download</button>
                    <button class="previewBtn">Preview</button>
                `;

                container.appendChild(title);
                container.appendChild(iframe);
                container.appendChild(controls);
                resultsDiv.appendChild(container);

                const meta = await window.pywebview.api.fetch_metadata(video.url);
                controls.querySelector('.resDisplay').textContent = meta.resolution || 'Unknown';
                controls.querySelector('.endTime').value = meta.duration || '';

                const btn = controls.querySelector('.downloadBtn');
                const previewBtn = controls.querySelector('.previewBtn');

                btn.onclick = async () => {
                    const start = controls.querySelector('.startTime').value || null;
                    const end = controls.querySelector('.endTime').value || null;
                    btn.textContent = 'Downloading...';
                    btn.disabled = true;
                    const msg = await window.pywebview.api.download(video.url, start, end);
                    btn.textContent = msg.includes('complete') ? '✔ Complete' : '✖ Failed';
    if (msg.includes('complete')) {
        const name = await window.pywebview.api.mark_trailer_downloaded();
        document.querySelectorAll('.folder-item').forEach(f => {
            if (f.textContent.includes(name)) {
                f.textContent = f.textContent.replace('❌', '✅');
            }
        });

        // ✅ Add check badge to video card
        const badge = document.createElement('div');
        badge.textContent = '✔ Downloaded';
        badge.style.cssText = "color: green; font-weight: bold; font-size: 14px; margin-top: 5px;";
        container.insertBefore(badge, iframe);
    }
                    btn.disabled = false;
                };

                previewBtn.onclick = async () => {
                    await window.pywebview.api.preview();
                };
            });
        }
    </script>
</body>
</html>
